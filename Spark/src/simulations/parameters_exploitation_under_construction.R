# =============================================================================
# SIMPLE EXPLORATION WRAPPER
# Uses your existing functions, just varies parameters and stores results
# =============================================================================

library(dplyr)

# Main function: varies all parameters and returns a dataframe
explore_parameters <- function(
    # Network structures to test
  mut_structures = c("random", "nested", "modular"),
  serv_structures = c("random", "nested"),
  serv_distributions = c("uniform", "lognormal"),
  
  # Network sizes
  n_species = 20,
  n_services = 5,
  
  # Environmental parameters (can be vectors)
  A_min = c(1, 3, 5),
  A_max = c(5, 8, 10),
  w_min = c(0.5, 1, 2),
  w_max = c(2, 3, 5),
  t_max = 100,
  
  # Cost/benefit parameters (can be vectors)
  B_shape1 = 0.5,
  B_shape2 = 0.5,
  Ce_shape1 = 0.5,
  Ce_shape2 = 0.5,
  Cp_shape1 = 0.5,
  Cp_shape2 = 0.5,
  Cp_multiplier = 0.2,
  
  # Zi parameters
  zi_min = 1,
  zi_max = 10,
  
  # Network parameters (can be vectors)
  connectance_mut = 0.3,
  connectance_serv = 0.3,
  n_modules_mut = 3,
  n_modules_serv = 3,
  
  # Replicates
  n_replicates = 5,
  seed = 123
) {
  
  # Create grid with all combinations
  params <- expand.grid(
    mut_struct = mut_structures,
    serv_struct = serv_structures,
    serv_dist = serv_distributions,
    A_min = A_min,
    A_max = A_max,
    w_min = w_min,
    w_max = w_max,
    B_sh1 = B_shape1,
    B_sh2 = B_shape2,
    Ce_sh1 = Ce_shape1,
    Ce_sh2 = Ce_shape2,
    Cp_sh1 = Cp_shape1,
    Cp_sh2 = Cp_shape2,
    Cp_mult = Cp_multiplier,
    conn_mut = connectance_mut,
    conn_serv = connectance_serv,
    n_mod_mut = n_modules_mut,
    n_mod_serv = n_modules_serv,
    replicate = 1:n_replicates,
    stringsAsFactors = FALSE
  )
  
  n_total <- nrow(params)
  cat(sprintf("\nTotal simulations: %d\n", n_total))
  cat("Running simulations...\n\n")
  
  # Store results
  results_list <- list()
  
  # Loop through all combinations
  for(i in 1:n_total) {
    
    if(i %% 50 == 0 | i == n_total) {
      cat(sprintf("  Progress: %d/%d (%.1f%%)\n", i, n_total, (i/n_total)*100))
    }
    
    set.seed(seed + i)
    p <- params[i, ]
    
    # YOUR interaction_networks function
    mut_net <- interaction_networks(
      sp_n = n_species,
      type = as.character(p$mut_struct),
      connectance = p$conn_mut,
      n_modules = p$n_mod_mut
    )
    
    # YOUR ecosystem_services_network function
    serv_net <- ecosystem_services_network(
      sp_n = n_species,
      services_n = n_services,
      type = as.character(p$serv_struct),
      distribution = as.character(p$serv_dist),
      connectance = p$conn_serv,
      n_modules = p$n_mod_serv
    )
    
    # YOUR environment function
    theta <- environment(p$A_min, p$A_max, p$w_min, p$w_max, t_max = t_max)
    
    # Generate species parameters
    B_vec <- rbeta(n_species, p$B_sh1, p$B_sh2)
    Ce_vec <- rbeta(n_species, p$Ce_sh1, p$Ce_sh2)
    Cp_vec <- rbeta(n_species, p$Cp_sh1, p$Cp_sh2) * p$Cp_mult
    zi <- runif(n_species, zi_min, zi_max)
    
    # YOUR simulation function
    dynamics <- simulation(mut_net, B_vec, Ce_vec, Cp_vec, zi, theta)
    
    # YOUR ecosystem function
    services <- ecosystem(dynamics, serv_net)
    
    # Store results in dataframe row
    results_list[[i]] <- data.frame(
      # Simulation ID
      sim_id = i,
      
      # Parameters
      mut_structure = p$mut_struct,
      serv_structure = p$serv_struct,
      serv_distribution = p$serv_dist,
      A_min = p$A_min,
      A_max = p$A_max,
      w_min = p$w_min,
      w_max = p$w_max,
      env_amplitude = p$A_max - p$A_min,
      env_frequency = p$w_max - p$w_min,
      B_shape1 = p$B_sh1,
      B_shape2 = p$B_sh2,
      Ce_shape1 = p$Ce_sh1,
      Ce_shape2 = p$Ce_sh2,
      Cp_shape1 = p$Cp_sh1,
      Cp_shape2 = p$Cp_sh2,
      Cp_multiplier = p$Cp_mult,
      connectance_mut = p$conn_mut,
      connectance_serv = p$conn_serv,
      n_modules_mut = p$n_mod_mut,
      n_modules_serv = p$n_mod_serv,
      replicate = p$replicate,
      
      # Results: species dynamics
      persistence_species = dynamics$prop_active_species,
      persistence_interactions = dynamics$prop_remaining_interactions,
      n_species_final = sum(dynamics$final_state),
      time_to_convergence = nrow(dynamics$state_history),
      
      # Results: ecosystem services
      services_initial = sum(services$E_initial),
      services_final = sum(services$E_final),
      services_loss = sum(services$delta_E),
      services_loss_relative = sum(services$delta_E) / sum(services$E_initial),
      
      stringsAsFactors = FALSE
    )
  }
  
  # Combine all results into one dataframe
  results_df <- bind_rows(results_list)
  
  cat(sprintf("\nCompleted! %d simulations.\n\n", nrow(results_df)))
  
  return(results_df)
}


# =============================================================================
# USAGE EXAMPLES
# =============================================================================

# Example 1: Quick test (few combinations)
test <- explore_parameters(
  mut_structures = c("random", "nested"),
  serv_structures = c("random"),
  serv_distributions = c("uniform"),
  A_min = c(1, 5),
  A_max = 10,
  w_min = 1,
  w_max = 3,
  n_replicates = 2
)

# View results
View(test)
head(test)


# Example 2: Vary environmental parameters
env_exploration <- explore_parameters(
  mut_structures = c("random", "nested", "modular"),
  serv_structures = c("random", "nested"),
  serv_distributions = c("uniform", "lognormal"),
  A_min = c(1, 3, 5),           # 3 values
  A_max = c(5, 8, 10),          # 3 values
  w_min = c(0.5, 1, 2),         # 3 values
  w_max = c(2, 3, 5),           # 3 values
  n_replicates = 5
)

# Save
write.csv(env_exploration, "results.csv", row.names = FALSE)
saveRDS(env_exploration, "results.rds")


# Example 3: Vary cost/benefit parameters
cost_exploration <- explore_parameters(
  mut_structures = c("nested", "modular"),
  serv_structures = c("nested"),
  A_min = 1,
  A_max = 10,
  w_min = 1,
  w_max = 5,
  Cp_multiplier = c(0.1, 0.2, 0.3, 0.4),  # Vary physiological cost
  B_shape1 = c(0.3, 0.5, 0.7),            # Vary benefit distribution
  n_replicates = 10
)


# Example 4: Vary network parameters
network_exploration <- explore_parameters(
  mut_structures = c("modular"),
  serv_structures = c("modular"),
  connectance_mut = c(0.1, 0.3, 0.5),     # Vary connectance
  connectance_serv = c(0.2, 0.4),
  n_modules_mut = c(2, 3, 4),              # Vary modularity
  n_modules_serv = c(2, 3, 4),
  A_min = 1,
  A_max = 10,
  w_min = 1,
  w_max = 5,
  n_replicates = 5
)


# Example 5: Full exploration (many combinations!)
full_results <- explore_parameters(
  mut_structures = c("random", "nested", "modular", "star", "path"),
  serv_structures = c("random", "nested", "modular", "star", "path"),
  serv_distributions = c("uniform", "lognormal", "beta"),
  A_min = c(1, 3, 5),
  A_max = c(5, 8, 10),
  w_min = c(0.5, 1, 2),
  w_max = c(2, 3, 5),
  Cp_multiplier = c(0.1, 0.2, 0.3),
  n_replicates = 5
)
# This creates: 5*5*3*3*3*3*3*3*5 = 91,125 simulations!


# =============================================================================
# QUICK ANALYSIS FUNCTIONS
# =============================================================================

# Summary by structure
summarize_by_structure <- function(df) {
  df %>%
    group_by(mut_structure, serv_structure) %>%
    summarise(
      n = n(),
      mean_persistence = mean(persistence_species),
      sd_persistence = sd(persistence_species),
      mean_services_final = mean(services_final),
      mean_services_loss = mean(services_loss_relative),
      .groups = "drop"
    )
}

# Summary by environmental conditions
summarize_by_environment <- function(df) {
  df %>%
    group_by(env_amplitude, env_frequency) %>%
    summarise(
      n = n(),
      mean_persistence = mean(persistence_species),
      mean_services = mean(services_final),
      mean_loss = mean(services_loss_relative),
      .groups = "drop"
    )
}


# =============================================================================
# SIMPLE PLOTS
# =============================================================================

library(ggplot2)

# Plot persistence by structure
plot_persistence <- function(df) {
  ggplot(df, aes(x = mut_structure, y = persistence_species, 
                 fill = serv_structure)) +
    geom_boxplot() +
    theme_minimal() +
    labs(title = "Species Persistence by Network Structure",
         x = "Mutualism Structure", 
         y = "Proportion of Persistent Species")
}

# Plot environmental effects
plot_environment <- function(df) {
  ggplot(df, aes(x = env_amplitude, y = services_loss_relative, 
                 color = mut_structure)) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "loess") +
    facet_wrap(~ serv_structure) +
    theme_minimal() +
    labs(title = "Environmental Impact on Services",
         x = "Environmental Amplitude",
         y = "Relative Services Loss")
}

# Plot persistence vs services
plot_correlation <- function(df) {
  ggplot(df, aes(x = persistence_species, y = services_final, 
                 color = mut_structure)) +
    geom_point(alpha = 0.6) +
    geom_smooth(method = "lm", se = FALSE) +
    theme_minimal() +
    labs(title = "Species Persistence vs Ecosystem Services",
         x = "Persistence", y = "Final Services")
}